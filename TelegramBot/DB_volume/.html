–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø <a href="https://t.me/student_helpergpt_bot">StudentHelper</a>,  –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–¥–∞ üë®‚Äçüíª

<pre><code class="language-python">import asyncio
from Config import dp, bot, admin_router
from Keyboards.keyboards import Keyboard
from aiogram import F, types
from States import FSMAdmin
from aiogram.fsm.context import FSMContext
from aiogram.filters import Command
from Service import TelegramUserService, AdminService, BotService
from aiogram.enums.parse_mode import ParseMode

@admin_router.message(Command('admin_menu'))
async def access_admin_menu(message: types.Message, state: FSMContext):
    await message.answer('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∞', reply_markup=Keyboard.Get_Admin_Menu())
    await state.set_state(FSMAdmin.choosing_action)

@admin_router.message(
    FSMAdmin.choosing_action,
    F.text == '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
)
async def send_statistics(message: types.Message, state: FSMContext):
    statistic_text = AdminService.GetStatistic()
    await message.answer(statistic_text)

@admin_router.message(
    FSMAdmin.choosing_action,
    F.text == '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤',
)
async def send_referral_menu(message: types.Message, state: FSMContext):
    await message.answer('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥', reply_markup=Keyboard.GetPeriodTypeKb())

@admin_router.callback_query(
    F.data.in_({'last_month', 'this_month', 'all_time'})
)
async def get_stat(call: types.CallbackQuery, state: FSMContext):
    result = AdminService.GetReferalStat(call.data)
    format_text = BotService.formatReferals(result, call.data)
    await call.message.edit_text(
        format_text,
        reply_markup=Keyboard.GetPeriodTypeKb()
    )

@admin_router.message(
    FSMAdmin.choosing_action,
    F.text == '–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞',
)
async def mass_message(message: types.Message, state: FSMContext):
    await message.answer('–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç (—Å —Ñ–æ—Ç–æ –∏–ª–∏ –±–µ–∑) –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏')
    await state.set_state(FSMAdmin.type_mass_message)

@admin_router.message(F.photo, FSMAdmin.type_mass_message)
async def process_mass_message_with_photo(message: types.Message, state: FSMContext):
    caption = message.caption if message.caption else ''
    photo = message.photo[-1].file_id

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã–µ (—Ñ–æ—Ç–æ –∏ –ø–æ–¥–ø–∏—Å—å) –≤ FSM
    await state.update_data(mass_message_type='photo', mass_message_caption=caption, mass_message_photo=photo)
    await message.answer_photo(
        photo=photo,
        caption=f"–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:\n\n{caption}",
        reply_markup=Keyboard.GetMassMessageConfirmationKeyboard()
    )

@admin_router.message(F.text, FSMAdmin.type_mass_message)
async def process_mass_message_with_text(message: types.Message, state: FSMContext):
    await state.update_data(mass_message_type='text', mass_message_caption=message.text)
    await message.answer(
        text=f"–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:\n\n{message.text}",
        reply_markup=Keyboard.GetMassMessageConfirmationKeyboard()
    )

async def send_mass_message_to_user(user: dict, message_type: str, text: str, photo: str = None):
    try:
        if message_type == 'text':
            await bot.send_message(
                chat_id=user.get('external_id'),
                text=text,
                parse_mode=ParseMode.HTML
            )
        elif message_type == 'photo':
            await bot.send_photo(
                chat_id=user.get('external_id'),
                photo=photo,
                caption=text,
                parse_mode=ParseMode.HTML
            )
    except Exception as e:
        print(f"Failed to send message to {user.get('username')}: {e}")

@admin_router.callback_query(F.data == "confirm_mass_message")
async def confirm_mass_message(callback: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    users = TelegramUserService.GetAllTelegramUsers()
    message_type = data['mass_message_type']
    text = data['mass_message_caption']
    tasks = []
    if message_type == 'text':
        for user in users:
            tasks.append(send_mass_message_to_user(user, message_type, text))
    elif message_type == 'photo':
        photo = data['mass_message_photo']
        for user in users:
            tasks.append(send_mass_message_to_user(user, message_type, text, photo=photo))
    await asyncio.gather(*tasks)
    await callback.message.answer('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!')
    await state.clear()

@admin_router.callback_query(F.data == "decline_mass_message")
async def decline_mass_message(callback: types.CallbackQuery, state: FSMContext):
    await callback.message.answer('–†–∞—Å—Å—ã–ª–∫–∞ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.')
    await state.clear()
</code></pre>
  
<b>–ü–æ—è—Å–Ω–µ–Ω–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º:</b>
  
1. <i>–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–π:</i> –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±—ã–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.
2. <i>–í—ã–Ω–µ—Å–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é</i> <code>send_mass_message_to_user</code> –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞.
3. <i>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ asyncio.gather:</i> –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —á—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
4. <i>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –µ–¥–∏–Ω–æ–≥–æ —Å—Ç–∏–ª—è –∫–æ–¥–∞:</i> –û–±—â–∏–π –ø–æ–¥—Ö–æ–¥ –∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π FSM.

–≠—Ç–∏ —É–ª—É—á—à–µ–Ω–∏—è –¥–µ–ª–∞—é—Ç –∫–æ–¥ –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
